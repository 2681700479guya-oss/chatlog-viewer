<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ChatGPT èŠå¤©è®°å½•æŸ¥çœ‹å™¨</title>
<style>
:root{
  --bg-light:#f6f6f7; --bg-dark:#1b1b1f;
  --text-light:#0f1115; --text-dark:#e7e7ea;
  --user:#0a84ff; --assistant:#5e5e66; --sys:#9b59b6;
  --chip:#d0d5dd22; --border:#00000014; --border-dark:#ffffff22;
  --sidebar-bg-light:#ffffff; --sidebar-bg-dark:#232329;
  --toolbar-bg-light:#ffffffee; --toolbar-bg-dark:#232329ee;
  --bubble-max:86%;
  --header-h:56px;
  --panel-h:52px;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;background:var(--bg-light);color:var(--text-light);transition:.25s}
body.dark{background:var(--bg-dark);color:var(--text-dark)}

header{position:sticky;top:0;z-index:40;backdrop-filter:saturate(180%) blur(8px);
  background:color-mix(in oklab,currentColor 6%,transparent);
  display:flex;gap:.6rem;align-items:center;justify-content:space-between;
  padding:.6rem .9rem;border-bottom:1px solid var(--border);min-height:var(--header-h)}
body.dark header{border-bottom-color:var(--border-dark)}
h1{font-size:1rem;margin:0;font-weight:600;display:flex;gap:.5rem;align-items:center}
.controls{display:flex;gap:.4rem;flex-wrap:wrap;align-items:center;justify-content:flex-end}
button,select,input[type="range"],input[type="text"]{
  padding:.45rem .7rem;border-radius:9px;border:1px solid var(--border);
  background:#fff;color:#111;cursor:pointer;font-size:.9rem
}
body.dark button,body.dark select,body.dark input[type="range"],body.dark input[type="text"]{
  background:#2a2a31;color:var(--text-dark);border-color:var(--border-dark)
}
button:active{transform:scale(.98)}
input[type=file]{display:none}
.icon{font-size:1.1rem}

/* é¡¶éƒ¨æ§åˆ¶å°ï¼ˆå¯æŠ˜å ï¼Œç²˜æ€§ï¼‰ */
.panel-wrap{position:sticky;top:var(--header-h);z-index:30}
.panel-toggle{
  display:flex;align-items:center;justify-content:space-between;
  height:var(--panel-h);padding:0 .9rem;border-bottom:1px solid var(--border);
  background:var(--toolbar-bg-light);backdrop-filter:saturate(180%) blur(6px)
}
body.dark .panel-toggle{background:var(--toolbar-bg-dark);border-bottom-color:var(--border-dark)}
.panel-toggle .hint{font-size:.88rem;opacity:.8}
.panel-content{
  display:none;
  padding:.7rem .9rem;border-bottom:1px solid var(--border);
  background:var(--toolbar-bg-light);backdrop-filter:saturate(180%) blur(6px)
}
body.dark .panel-content{background:var(--toolbar-bg-dark);border-bottom-color:var(--border-dark)}
.panel.open .panel-content{display:block}
.group{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap;margin:.25rem 0}
.badge{padding:.2rem .5rem;border-radius:7px;border:1px solid var(--border);font-size:.78rem;opacity:.9}
body.dark .badge{border-color:var(--border-dark)}
.colorbox{display:flex;gap:.5rem;align-items:center}
.colorbox label{font-size:.82rem;opacity:.85}
.colorbox input[type=color]{width:32px;height:28px;padding:0;border:none;background:transparent}

/* å¸ƒå±€ï¼šä¾§è¾¹æ  + å†…å®¹ */
.layout{display:flex}
.sidebar{
  position:fixed;left:0;top:var(--header-h);height:calc(100dvh - var(--header-h));width:280px;
  background:var(--sidebar-bg-light);color:inherit;border-right:1px solid var(--border);
  transform:translateX(-100%);transition:transform .25s ease;z-index:35;display:flex;flex-direction:column
}
body.dark .sidebar{background:var(--sidebar-bg-dark);border-right-color:var(--border-dark)}
.sidebar.open{transform:translateX(0)}
.sidebar .side-head{padding:.8rem .9rem;border-bottom:1px solid var(--border)}
body.dark .sidebar .side-head{border-bottom-color:var(--border-dark)}
.sidebar .list{overflow:auto;padding:.5rem}
.conv-item{
  padding:.6rem .7rem;border-radius:10px;margin:.25rem 0;cursor:pointer;border:1px solid transparent
}
.conv-item:hover{background:color-mix(in oklab,currentColor 6%,transparent)}
.conv-item.active{border-color:var(--border-dark)}
.meta-mini{font-size:.75rem;opacity:.7;margin-top:.2rem}

/* é®ç½© */
.backdrop{
  position:fixed;inset:0;background:rgba(0,0,0,.2);backdrop-filter:blur(1px);
  opacity:0;pointer-events:none;transition:.2s;z-index:25
}
.backdrop.show{opacity:1;pointer-events:auto}

/* ä¸»å†…å®¹ */
.container{padding:1rem;display:flex;flex-direction:column;gap:.9rem;max-width:980px;margin:0 auto}
.chat{display:flex;flex-direction:column;gap:.8rem}
.msg{max-width:var(--bubble-max);padding:.65rem .85rem;border-radius:14px;white-space:pre-wrap;line-height:1.55}
.user{align-self:flex-end;background:var(--user);color:#fff}
.assistant{align-self:flex-start;background:var(--assistant);color:#fff}
.system{align-self:center;background:var(--sys);color:#fff}
.name{font-size:.78rem;opacity:.8;margin:0 .2rem .2rem .2rem}
.meta{display:flex;justify-content:space-between;gap:.6rem;margin-top:.35rem;font-size:.78rem;opacity:.9}
.model{padding:.15rem .5rem;border-radius:999px;background:var(--chip)}
.branch{margin-top:.5rem;border:1px dashed var(--border);border-radius:10px;padding:.5rem}
body.dark .branch{border-color:var(--border-dark)}
.branch>summary{cursor:pointer;font-size:.85rem;opacity:.9}
.branch-thread{display:flex;flex-direction:column;gap:.5rem;margin-top:.6rem}

/* é”™è¯¯æç¤ºæ¡ */
.errbar{position:fixed;left:0;right:0;bottom:0;z-index:50;
  background:#c0392b;color:#fff;padding:.6rem .9rem;display:none}
.errbar.show{display:block}

/* å®½å±å¸¸é©»ä¾§æ  */
@media (min-width:1100px){
  .sidebar{transform:translateX(0)}
  .backdrop{display:none}
  .container{margin-left:280px}
}
</style>
</head>
<body>
<header>
  <h1><button id="burger" class="icon" aria-label="èœå•">â˜°</button>ğŸ“„ ChatGPT èŠå¤©è®°å½•æŸ¥çœ‹å™¨</h1>
  <div class="controls">
    <input id="file" type="file" accept=".json" />
    <button onclick="pickFile()">å¯¼å…¥</button>
    <button onclick="exportHTML()">å¯¼å‡ºé¡µé¢</button>
    <button onclick="toggleTheme()">å¤œé—´/æ—¥é—´</button>
  </div>
</header>

<div class="panel-wrap">
  <div class="panel" id="topPanel">
    <div class="panel-toggle">
      <span class="hint">âš™ï¸ æ§åˆ¶å°ï¼ˆä¼šè¯ / å¤–è§‚ / æ˜¾ç¤ºåï¼‰</span>
      <button id="togglePanelBtn">å±•å¼€</button>
    </div>
    <div class="panel-content">
      <div class="group">
        <span class="badge">ä¼šè¯ï¼š</span>
        <select id="convListTop" onchange="selectConversation(this.value)"></select>
        <span class="badge" id="convMeta" title="åˆ›å»ºæ—¶é—´ / æ¶ˆæ¯æ•°"></span>
        <span class="badge">æ¨¡å‹è¿‡æ»¤ï¼š</span>
        <select id="modelFilter" onchange="applyModelFilter()"><option value="">å…¨éƒ¨</option></select>
      </div>
      <div class="group">
        <span class="badge">å¤–è§‚ï¼š</span>
        <div class="colorbox">
          <label>ç”¨æˆ·</label><input type="color" id="cUser">
          <label>åŠ©æ‰‹</label><input type="color" id="cAssistant">
          <label>ç³»ç»Ÿ</label><input type="color" id="cSystem">
        </div>
        <span class="badge">æ°”æ³¡å®½åº¦ï¼š</span>
        <input type="range" id="bubbleWidth" min="60" max="100" value="86" oninput="setBubbleWidth(this.value)">
        <span id="bubbleVal" class="badge" style="opacity:.7">86%</span>
        <button onclick="resetTheme()">æ¢å¤é»˜è®¤</button>
      </div>
      <div class="group">
        <span class="badge">æ˜¾ç¤ºåï¼š</span>
        <input id="nameUser" type="text" placeholder="ç”¨æˆ·æ˜¾ç¤ºå" style="width:8.5rem">
        <input id="nameAssistant" type="text" placeholder="åŠ©æ‰‹æ˜¾ç¤ºå" style="width:8.5rem">
        <input id="nameSystem" type="text" placeholder="ç³»ç»Ÿæ˜¾ç¤ºå" style="width:8.5rem">
        <button onclick="saveNames()">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar">
    <div class="side-head">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
        <strong>ä¼šè¯åˆ—è¡¨</strong>
        <button id="closeSidebar">å…³é—­</button>
      </div>
      <div class="small" style="opacity:.6">å¯¼å…¥ conversations.json æˆ–å•ä¼šè¯åæ˜¾ç¤º</div>
    </div>
    <div class="list" id="convListSide"></div>
  </aside>
  <div class="backdrop" id="backdrop"></div>

  <main class="container">
    <div id="chat" class="chat">
      <p style="opacity:.6;text-align:center">å¯¼å…¥ ChatGPT å®˜æ–¹å¯¼å‡ºçš„ä¼šè¯ JSONï¼ˆå•ä¸ªä¼šè¯æˆ– conversations.jsonï¼‰ã€‚</p>
    </div>
    <footer class="small" style="opacity:.75">ç¦»çº¿è¿è¡Œï½œä¸»è·¯å¾„å‘ˆç°ï¼Œåˆ†æ”¯ä¸ºå­çº¿ç¨‹æ°”æ³¡ï½œé¢œè‰²/å®½åº¦/æ˜¾ç¤ºåä¼šä¿å­˜åˆ°æœ¬åœ°</footer>
  </main>
</div>

<div id="err" class="errbar"></div>

<script>
/* ---------- å…ˆæŠ“å…ƒç´ ï¼ˆé‡è¦ï¼šåœ¨ä»»ä½•å‡½æ•°ç”¨åˆ°å‰å°±æ‹¿åˆ°ï¼‰ ---------- */
const panelEl = document.getElementById('topPanel');
const toggleBtn = document.getElementById('togglePanelBtn');
const errBar = document.getElementById('err');
function showErr(msg){ errBar.textContent = msg; errBar.classList.add('show'); setTimeout(()=>errBar.classList.remove('show'), 6000); }

/* ================== åå¥½ & ä¸»é¢˜ ================== */
let dark=false;
const PREF_KEY='chatviewer_prefs_v5';
const prefs=loadPrefs();

applyPrefs(); // ç°åœ¨å®‰å…¨ï¼Œå› ä¸º toggleBtn/panelEl å·²æ‹¿åˆ°

function toggleTheme(){try{dark=!dark;document.body.classList.toggle('dark',dark);prefs.dark=dark;savePrefs();}catch(e){showErr('åˆ‡æ¢ä¸»é¢˜å¤±è´¥ï¼š'+e.message)}}
function loadPrefs(){try{return JSON.parse(localStorage.getItem(PREF_KEY))||{};}catch{return{};}}
function savePrefs(){try{localStorage.setItem(PREF_KEY,JSON.stringify(prefs));}catch(e){showErr('ä¿å­˜åå¥½å¤±è´¥ï¼š'+e.message)}}
function setCSS(varName,val){document.documentElement.style.setProperty(varName,val);}
function applyPrefs(){
  try{
    dark=!!prefs.dark;document.body.classList.toggle('dark',dark);
    if(prefs.colors){
      if(prefs.colors.user)setCSS('--user',prefs.colors.user);
      if(prefs.colors.assistant)setCSS('--assistant',prefs.colors.assistant);
      if(prefs.colors.sys)setCSS('--sys',prefs.colors.sys);
    }
    if(prefs.bubble){setCSS('--bubble-max',prefs.bubble+'%');}
    if(prefs.names){
      const u=document.getElementById('nameUser'); if(u) u.value=prefs.names.user||'';
      const a=document.getElementById('nameAssistant'); if(a) a.value=prefs.names.assistant||'';
      const s=document.getElementById('nameSystem'); if(s) s.value=prefs.names.system||'';
    }
    setPanelOpen(!!prefs.panelOpen); // æ­¤å¤„å·²å®‰å…¨
    setTimeout(()=>{
      if(prefs.colors){
        if(prefs.colors.user)document.getElementById('cUser').value=prefs.colors.user;
        if(prefs.colors.assistant)document.getElementById('cAssistant').value=prefs.colors.assistant;
        if(prefs.colors.sys)document.getElementById('cSystem').value=prefs.colors.sys;
      }
      if(prefs.bubble){
        document.getElementById('bubbleWidth').value=Number(prefs.bubble);
        document.getElementById('bubbleVal').textContent=`${prefs.bubble}%`;
      }
    },0);
  }catch(e){showErr('åº”ç”¨åå¥½å¤±è´¥ï¼š'+e.message)}
}
function resetTheme(){
  try{
    ['--user','--assistant','--sys'].forEach(v=>document.documentElement.style.removeProperty(v));
    document.getElementById('cUser').value='#0a84ff';
    document.getElementById('cAssistant').value='#5e5e66';
    document.getElementById('cSystem').value='#9b59b6';
    setBubbleWidth(86);
    prefs.colors={user:'#0a84ff',assistant:'#5e5e66',sys:'#9b59b6'};
    prefs.bubble=86;
    prefs.names={user:'',assistant:'',system:''};
    document.getElementById('nameUser').value='';
    document.getElementById('nameAssistant').value='';
    document.getElementById('nameSystem').value='';
    savePrefs(); render();
  }catch(e){showErr('æ¢å¤é»˜è®¤å¤±è´¥ï¼š'+e.message)}
}
document.getElementById('cUser').addEventListener('input',e=>{setCSS('--user',e.target.value);prefs.colors=prefs.colors||{};prefs.colors.user=e.target.value;savePrefs();});
document.getElementById('cAssistant').addEventListener('input',e=>{setCSS('--assistant',e.target.value);prefs.colors=prefs.colors||{};prefs.colors.assistant=e.target.value;savePrefs();});
document.getElementById('cSystem').addEventListener('input',e=>{setCSS('--sys',e.target.value);prefs.colors=prefs.colors||{};prefs.colors.sys=e.target.value;savePrefs();});
function setBubbleWidth(val){setCSS('--bubble-max',`${val}%`);document.getElementById('bubbleVal').textContent=`${val}%`;prefs.bubble=Number(val);savePrefs();}

/* æ˜¾ç¤ºå */
function saveNames(){
  try{
    prefs.names={
      user:document.getElementById('nameUser').value.trim(),
      assistant:document.getElementById('nameAssistant').value.trim(),
      system:document.getElementById('nameSystem').value.trim()
    };
    savePrefs(); render();
  }catch(e){showErr('ä¿å­˜æ˜¾ç¤ºåå¤±è´¥ï¼š'+e.message)}
}

/* æ§åˆ¶å°å¼€åˆï¼ˆåˆå§‹åŒ–é¡ºåºå·²ä¿®å¤ï¼‰ */
toggleBtn.addEventListener('click', ()=> setPanelOpen(!panelEl.classList.contains('open')));
function setPanelOpen(open){
  panelEl.classList.toggle('open', open);
  if (toggleBtn) toggleBtn.textContent = open ? 'æ”¶èµ·' : 'å±•å¼€';
  prefs.panelOpen = open; savePrefs();
}

/* ================== æ–‡ä»¶å¯¼å…¥ ================== */
function pickFile(){document.getElementById('file').click();}
document.getElementById('file').addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f)return;
  try{
    const raw=await f.text();
    let data; try{data=JSON.parse(raw);}catch{throw new Error('ä¸æ˜¯æœ‰æ•ˆ JSONï¼šè¯·å¯¼å…¥ ChatGPT å®˜æ–¹å¯¼å‡ºè§£å‹åçš„ JSON');}
    handleImportedJSON(data);
  }catch(err){ showErr(err.message||String(err)); }
});

/* ================== ä¾§è¾¹æ  ================== */
const sidebar=document.getElementById('sidebar');
const backdrop=document.getElementById('backdrop');
document.getElementById('burger').addEventListener('click',()=>openSidebar(true));
document.getElementById('closeSidebar').addEventListener('click',()=>openSidebar(false));
backdrop.addEventListener('click',()=>openSidebar(false));
function openSidebar(show){
  if(window.matchMedia('(min-width:1100px)').matches){return;}
  sidebar.classList.toggle('open',show);
  backdrop.classList.toggle('show',show);
}

/* ================== è§£æä¸çŠ¶æ€ ================== */
let conversations=[]; // {id,title,created,messages:[...],models:Set}
let currentConvIndex=0;
let renderCache={model:""};

function handleImportedJSON(data){
  try{
    conversations=[];
    if(Array.isArray(data)){
      data.forEach(obj=>{const c=parseConversation(obj);if(c)conversations.push(c);});
    }else if(data&&typeof data==='object'){
      if(data.items&&Array.isArray(data.items)){data.items.forEach(obj=>{const c=parseConversation(obj);if(c)conversations.push(c);});}
      else{const c=parseConversation(data);if(c)conversations.push(c);}
    }
    if(!conversations.length){throw new Error('æ²¡è§£æåˆ°ä¼šè¯ã€‚è¯·é€‰æ‹© conversations.json æˆ– conversations/*.json');}

    buildTopSelect();
    buildSidebarList();

    currentConvIndex=0;
    setTopSelect('0');
    updateConvMeta();
    buildModelFilter();
    render();
    setPanelOpen(true); // é¦–æ¬¡å¯¼å…¥è‡ªåŠ¨å±•å¼€æ§åˆ¶å°ï¼Œä¾¿äºæ“ä½œ
  }catch(e){ showErr('å¯¼å…¥å¤±è´¥ï¼š'+(e.message||e)); }
}

function buildTopSelect(){
  const sel=document.getElementById('convListTop'); sel.innerHTML='';
  conversations.forEach((c,idx)=>{
    const opt=document.createElement('option');
    opt.value=String(idx); opt.textContent=c.title||`(æ— æ ‡é¢˜) ${idx+1}`; sel.appendChild(opt);
  });
}
function setTopSelect(val){document.getElementById('convListTop').value=val;}

function buildSidebarList(){
  const list=document.getElementById('convListSide'); list.innerHTML='';
  conversations.forEach((c,idx)=>{
    const item=document.createElement('div');
    item.className='conv-item'+(idx===currentConvIndex?' active':'');
    item.innerHTML=`<div>${escapeHTML(c.title||`(æ— æ ‡é¢˜) ${idx+1}`)}</div>
      <div class="meta-mini">æ¶ˆæ¯ ${c.messages.length}${c.created?` Â· ${new Date(c.created*1000).toLocaleDateString()}`:''}</div>`;
    item.onclick=()=>{
      currentConvIndex=idx;
      setTopSelect(String(idx));
      updateConvMeta();
      buildModelFilter();
      activateSidebarItem(idx);
      openSidebar(false);
      render();
    };
    list.appendChild(item);
  });
}
function activateSidebarItem(idx){
  const list=document.getElementById('convListSide');
  [...list.children].forEach(el=>el.classList.remove('active'));
  if(list.children[idx]) list.children[idx].classList.add('active');
}
function selectConversation(idxStr){
  currentConvIndex=Number(idxStr)||0;
  document.getElementById('modelFilter').value="";
  updateConvMeta();
  buildModelFilter();
  activateSidebarItem(currentConvIndex);
  render();
}
function updateConvMeta(){
  const c=conversations[currentConvIndex];
  const meta=document.getElementById('convMeta');
  const created=c.created?new Date(c.created*1000).toLocaleString():'â€”';
  meta.textContent=`åˆ›å»ºï¼š${created}ï½œæ¶ˆæ¯æ•°ï¼š${c.messages.length}`;
}

/* è§£æ mapping æ ‘ */
function parseConversation(obj){
  const title=obj.title||obj.gist||obj.name||'';
  const created=obj.create_time||obj.update_time||obj.created||0;
  const mapping=obj.mapping; const current=obj.current_node;

  if(!mapping||!current){
    if(Array.isArray(obj.messages)){
      const msgs=obj.messages.map(normalizeLinearMessage).filter(Boolean);
      return {id:obj.id||crypto.randomUUID(),title,created,messages:msgs,models:new Set(msgs.map(m=>m.model).filter(Boolean))};
    }
    return null;
  }
  const pathIds=[]; let nodeId=current;
  while(nodeId&&mapping[nodeId]){pathIds.push(nodeId);nodeId=mapping[nodeId].parent||null;}
  pathIds.reverse();

  const messages=[]; const pathSet=new Set(pathIds);
  pathIds.forEach(pid=>{const n=mapping[pid];const m=normalizeNodeMessage(n);if(m)messages.push(m);});
  const idToIndex=new Map(); messages.forEach((m,i)=>idToIndex.set(m._nodeId,i));

  pathIds.forEach(pid=>{
    const node=mapping[pid];
    const children=Array.isArray(node.children)?node.children:[];
    const branchKids=children.filter(cid=>!pathSet.has(cid));
    if(!branchKids.length) return;
    const branchArr=[];
    branchKids.forEach(bid=>collectBranchObjects(mapping,bid,branchArr));
    const at=idToIndex.get(pid);
    if(typeof at==='number' && branchArr.length){ messages[at].previous = branchArr.slice(0,300); }
  });

  const msgs=messages.filter(m=>m.content&&m.content.trim().length);
  return {id:obj.id||crypto.randomUUID(),title,created,messages:msgs,models:new Set(msgs.map(m=>m.model).filter(Boolean))};
}
function normalizeLinearMessage(m){
  const role=m.role||(m.author?.role)||"assistant";
  const parts=Array.isArray(m.content?.parts)?m.content.parts.join("\n"):(m.content?.text||m.content||"");
  const content=typeof parts==='string'?parts:JSON.stringify(parts);
  const model=m.model||m.metadata?.model_slug||m.metadata?.model||"";
  const ts=m.create_time||m.ts||0;
  return {role,content,model,ts,previous:[]};
}
function normalizeNodeMessage(node){
  const msg=node.message; if(!msg||!msg.author)return null;
  const role=msg.author.role||"assistant";
  if(!["user","assistant","system"].includes(role))return null;
  let text="";
  if(Array.isArray(msg.content?.parts)) text=msg.content.parts.join("\n");
  else if(typeof msg.content?.text==='string') text=msg.content.text;
  else if(typeof msg.content==='string') text=msg.content;
  const model=msg.metadata?.model_slug||msg.metadata?.model||msg.model_slug||msg.model||"";
  const ts=msg.create_time||node.create_time||0;
  return {role,content:text||"",model,ts,previous:[],_nodeId:node.id};
}
function collectBranchObjects(mapping,startId,out){
  const stack=[startId];
  while(stack.length){
    const id=stack.pop(); const n=mapping[id]; if(!n)continue;
    const m=normalizeNodeMessage(n);
    if(m && m.content){ out.push({role:m.role,content:m.content,ts:m.ts,model:m.model}); }
    const kids=Array.isArray(n.children)?n.children:[];
    for(let i=kids.length-1;i>=0;i--) stack.push(kids[i]);
  }
}

/* ================== æ¸²æŸ“ ================== */
function displayName(role){
  const n=prefs.names||{};
  if(role==='user')return n.user||'';
  if(role==='assistant')return n.assistant||'';
  if(role==='system')return n.system||'';
  return '';
}
function render(){
  try{
    const chat=document.getElementById('chat'); chat.innerHTML='';
    const c=conversations[currentConvIndex]; if(!c){chat.textContent='æ— ä¼šè¯';return;}
    let arr=c.messages.slice();
    if(renderCache.model){arr=arr.filter(m=>(m.model||"").includes(renderCache.model));}

    if(!arr.length){
      const p=document.createElement('p'); p.style.opacity=.6; p.style.textAlign='center';
      p.textContent='ç­›é€‰åæ²¡æœ‰æ¶ˆæ¯ã€‚è°ƒæ•´æ¨¡å‹è¿‡æ»¤è¯•è¯•ã€‚'; chat.appendChild(p); return;
    }

    arr.forEach(m=>{
      const name=displayName(m.role);
      if(name){
        const nm=document.createElement('div'); nm.className='name';
        nm.style.alignSelf=(m.role==='user'?'flex-end':m.role==='assistant'?'flex-start':'center');
        nm.textContent=name; chat.appendChild(nm);
      }
      const div=document.createElement('div'); div.className=`msg ${clsByRole(m.role)}`; div.innerText=m.content||''; chat.appendChild(div);

      const meta=document.createElement('div'); meta.className='meta';
      const ts=m.ts?new Date(m.ts*1000).toLocaleString():'';
      const model=m.model||'';
      meta.innerHTML=`<span style="opacity:.7">${ts}</span><span class="model">${escapeHTML(model||'â€”')}</span>`;
      chat.appendChild(meta);

      if(Array.isArray(m.previous) && m.previous.length){
        const details=document.createElement('details'); details.className='branch';
        const summary=document.createElement('summary'); summary.textContent=`å›æº¯/åˆ†æ”¯ï¼ˆ${m.previous.length} æ¡ï¼‰`;
        details.appendChild(summary);
        const thread=document.createElement('div'); thread.className='branch-thread';
        m.previous.forEach(b=>{
          const nm2=displayName(b.role);
          if(nm2){
            const nm=document.createElement('div'); nm.className='name';
            nm.style.alignSelf=(b.role==='user'?'flex-end':b.role==='assistant'?'flex-start':'center');
            nm.textContent=nm2; thread.appendChild(nm);
          }
          const bdiv=document.createElement('div'); bdiv.className=`msg ${clsByRole(b.role)}`; bdiv.innerText=b.content||''; thread.appendChild(bdiv);
          const m2=document.createElement('div'); m2.className='meta';
          const ts2=b.ts?new Date(b.ts*1000).toLocaleString():'';
          const model2=b.model||'';
          m2.innerHTML=`<span style="opacity:.6">${ts2}</span><span class="model">${escapeHTML(model2||'â€”')}</span>`;
          thread.appendChild(m2);
        });
        details.appendChild(thread);
        chat.appendChild(details);
      }
    });
  }catch(e){showErr('æ¸²æŸ“å¤±è´¥ï¼š'+e.message)}
}
function clsByRole(role){if(role==='user')return 'user';if(role==='system')return 'system';return 'assistant';}

/* è¿‡æ»¤ï¼ˆä»…æ¨¡å‹ï¼‰ */
function buildModelFilter(){
  const sel=document.getElementById('modelFilter'); sel.innerHTML=`<option value="">å…¨éƒ¨</option>`;
  const c=conversations[currentConvIndex]; const arr=Array.from(c.models||[]).sort();
  arr.forEach(m=>{const op=document.createElement('option');op.value=m;op.textContent=m;sel.appendChild(op);});
}
function applyModelFilter(){renderCache.model=document.getElementById('modelFilter').value||"";render();}

/* å¯¼å‡º */
function exportHTML(){
  try{
    const blob=new Blob([document.documentElement.outerHTML],{type:'text/html'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='chat_export.html'; a.click(); URL.revokeObjectURL(url);
  }catch(e){showErr('å¯¼å‡ºå¤±è´¥ï¼š'+e.message)}
}

/* å·¥å…· */
function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
</script>
</body>
</html>
