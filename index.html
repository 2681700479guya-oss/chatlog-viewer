<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatGPT 聊天记录查看器</title>
<style>
:root {
  --bg-light: #f5f5f5;
  --bg-dark: #1e1e1e;
  --user-color: #0078ff;
  --assistant-color: #666;
  --text-light: #111;
  --text-dark: #ddd;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
  margin: 0;
  padding: 0;
  background-color: var(--bg-light);
  color: var(--text-light);
  transition: all .3s;
}
body.dark {
  background-color: var(--bg-dark);
  color: var(--text-dark);
}
header {
  position: sticky;
  top: 0;
  background: inherit;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: .5em 1em;
  border-bottom: 1px solid #ccc;
}
button {
  padding: .4em .8em;
  margin-left: .4em;
  border-radius: 4px;
  border: none;
  cursor: pointer;
}
.chat-container {
  padding: 1em;
  display: flex;
  flex-direction: column;
  gap: .8em;
}
.message {
  max-width: 85%;
  padding: .6em .9em;
  border-radius: 10px;
  white-space: pre-wrap;
  line-height: 1.5;
}
.user {
  align-self: flex-end;
  background: var(--user-color);
  color: white;
}
.assistant {
  align-self: flex-start;
  background: var(--assistant-color);
  color: white;
}
.model-tag {
  font-size: 0.8em;
  opacity: 0.8;
  display: block;
  text-align: right;
  margin-top: .3em;
}
.collapsible {
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: .5em;
  background: rgba(0,0,0,0.05);
}
.hidden { display: none; }
</style>
</head>
<body>
<header>
  <div>📄 ChatGPT 聊天记录查看器</div>
  <div>
    <input type="file" id="fileInput" accept=".json,.txt" style="display:none">
    <button onclick="document.getElementById('fileInput').click()">导入</button>
    <button onclick="exportChat()">导出</button>
    <button onclick="toggleTheme()">夜间/日间</button>
  </div>
</header>

<div class="chat-container" id="chatContainer">
  <p style="opacity:.6;text-align:center;">请选择聊天记录文件导入</p>
</div>

<script>
let darkMode = false;
function toggleTheme(){
  darkMode = !darkMode;
  document.body.classList.toggle("dark", darkMode);
}

document.getElementById('fileInput').addEventListener('change', async function(e){
  const file = e.target.files[0];
  if(!file) return;
  const text = await file.text();
  try{
    const data = JSON.parse(text);
    renderChat(data);
  }catch{
    alert("文件格式错误，请导入 JSON 格式的聊天记录。");
  }
});

function renderChat(data){
  const container = document.getElementById('chatContainer');
  container.innerHTML = '';
  data.forEach((msg, i)=>{
    const div = document.createElement('div');
    div.classList.add('message', msg.role);
    let content = msg.content || "";
    const model = msg.model ? `<span class='model-tag'>${msg.model}</span>` : "";
    // 如果有回溯消息，可折叠
    if (msg.previous && msg.previous.length > 0){
      const wrapper = document.createElement('div');
      wrapper.classList.add('collapsible');
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = `展开/收起回溯 (${msg.previous.length})`;
      const hiddenDiv = document.createElement('div');
      hiddenDiv.classList.add('hidden');
      msg.previous.forEach(p=>{
        const pDiv = document.createElement('div');
        pDiv.textContent = p;
        pDiv.style.margin=".3em 0";
        hiddenDiv.appendChild(pDiv);
      });
      toggleBtn.onclick = ()=>hiddenDiv.classList.toggle('hidden');
      wrapper.appendChild(toggleBtn);
      wrapper.appendChild(hiddenDiv);
      div.appendChild(wrapper);
    }
    div.insertAdjacentHTML('beforeend', content + model);
    container.appendChild(div);
  });
}

function exportChat(){
  const html = document.documentElement.outerHTML;
  const blob = new Blob([html], {type:"text/html"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chat_export.html';
  a.click();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
