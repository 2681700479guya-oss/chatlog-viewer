<!doctype html>
<html lang="zh-cn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>聊天记录查看/导出（手机优化｜可选回溯）</title>
<style>
  :root{
    --bg:#0c0f14; --panel:#11151d; --muted:#93a0b8; --text:#e8edf6; --accent:#6aa1ff;
    --line:#202637; --bubble:#0f1320; --user:#0c1710; --asst:#0b1220;
    --radius:14px; --tap:18px; --gap:10px; --fs:16px;
  }
  *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--text); font:var(--fs)/1.45 -apple-system, system-ui, "PingFang SC","Noto Sans SC","Microsoft Yahei",sans-serif; }
  .app{ display:grid; grid-template-rows:auto 1fr auto; height:100%; }

  /* 顶部条 */
  header{ position:sticky; top:0; z-index:5; display:flex; gap:8px; align-items:center;
    padding:12px max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
    background:var(--panel); border-bottom:1px solid var(--line); }
  header h1{ margin:0; font-size:16px; font-weight:600; letter-spacing:.2px; }
  .spacer{ flex:1; }
  .btn{ font-size:15px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#151b28; color:var(--text); cursor:pointer; transition:all 0.2s ease; }
  .btn:hover{ background:#1a2235; }
  .btn.primary{ background:linear-gradient(180deg,#2a66ff,#1e4fe0); border:none; }
  .btn.primary:hover{ background:linear-gradient(180deg,#3a76ff,#2e5ff0); }
  .btn.ghost{ background:transparent; }
  .btn:disabled{ opacity:.55; cursor:not-allowed; }
  .pill{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); background:#0e1320; }

  /* 主体：左列表 + 右聊天视图（窄屏纵向堆叠） */
  main{ display:grid; grid-template-columns: 1fr; min-height:0; }
  @media (min-width: 980px){
    main{ grid-template-columns: 380px 1fr; }
  }

  /* 侧栏（列表） */
  aside{ display:flex; flex-direction:column; min-height:0; border-bottom:1px solid var(--line); }
  @media (min-width: 980px){ aside{ border-bottom:0; border-right:1px solid var(--line);} }

  .toolbar{ padding:10px 12px; display:grid; gap:10px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.02);}
  .toolbar .row{ display:flex; gap:8px; }
  input[type="search"], select, input[type="text"]{
    width:100%; background:#0a0f1a; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:12px 14px; font-size:16px;
  }
  .toggle{ display:flex; align-items:center; gap:8px; background:#0a1020; color:var(--muted);
    border:1px solid var(--line); padding:10px 12px; border-radius:999px; cursor:pointer; }
  .toggle input{ width:22px; height:22px; accent-color:var(--accent); }
  .drop{ border:1px dashed #2b3756; background:#0a0f1a; color:#9bb0d6; padding:12px; border-radius:12px; text-align:center; transition:all 0.2s ease; cursor:pointer; }
  .drop:hover{ background:#0d1220; border-color:#3a4a75; }

  .list{ overflow:auto; -webkit-overflow-scrolling:touch; min-height:0; }
  .msg{ display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
        padding:12px; border-bottom:1px solid var(--line); cursor:pointer; transition:background 0.2s ease; }
  .msg:hover{ background:#0f1422; }
  .msg.selected{ background:#0f1a30; }
  .ck{ width:22px; height:22px; cursor:pointer; }
  .badge{ font-size:12px; padding:4px 8px; border-radius:8px; border:1px solid var(--line); }
  .badge.user{ color:#9ae6b4; background:#0c1710; border-color:#243b2c; }
  .badge.assistant{ color:#b4c8ff; background:#0b1220; border-color:#243056; }
  .badge.system{ color:#eabfff; background:#160e20; border-color:#4a2e66; }
  .badge.tool{ color:#ffd39a; background:#1f140b; border-color:#5a3b17; }
  .pv{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#cfd5e6; }
  .ts{ color:var(--muted); font-size:12px; }

  .countbar{ padding:8px 12px; border-top:1px solid var(--line); display:flex; gap:8px; align-items:center; color:var(--muted); }
  .countbar .right{ margin-left:auto; display:flex; gap:8px; }

  /* 聊天视图 */
  .viewer{ display:flex; flex-direction:column; min-height:0; }
  .chatHead{ display:flex; gap:8px; align-items:center; padding:12px; border-bottom:1px solid var(--line); background:rgba(255,255,255,.02); }
  .chatHead .meta{ color:var(--muted); font-size:13px; display:flex; gap:10px; flex-wrap:wrap; }
  .chat{ flex:1; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px; display:flex; flex-direction:column; gap:12px; }
  .day{ text-align:center; color:var(--muted); font-size:12px; margin:10px 0 4px; }
  .bubble{ max-width:100%; background:var(--bubble); border:1px solid var(--line); padding:12px; border-radius:var(--radius); white-space:pre-wrap; word-break:break-word; }
  .rowU, .rowA, .rowS, .rowT{ display:flex; gap:10px; }
  .rowU{ justify-content:flex-end; }
  .rowA, .rowS, .rowT{ justify-content:flex-start; }
  .bubble.user{ background:#0f1712; }
  .bubble.assistant{ background:#0f1320; }
  .bubble.system{ background:#160e20; }
  .bubble.tool{ background:#1f140b; }
  .who{ font-size:12px; color:var(--muted); margin:0 4px; }

  .chatFoot{ padding:10px max(12px, env(safe-area-inset-left)) 12px max(12px, env(safe-area-inset-right));
    border-top:1px solid var(--line); display:flex; flex-wrap:wrap; gap:10px; align-items:center; background:var(--panel); }
  .chip{ padding:8px 12px; border-radius:999px; background:#0a1020; border:1px solid var(--line); color:var(--muted); display:flex; align-items:center; gap:8px; cursor:pointer; }
  .chip input[type="checkbox"]{ width:22px; height:22px; accent-color:var(--accent); }
  .range{ display:flex; align-items:center; gap:10px; color:var(--muted); }
  input[type="range"]{ width:160px; }

  .footRight{ margin-left:auto; display:flex; gap:8px; }
  .kbd{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; border:1px solid var(--line); padding:2px 6px; border-radius:6px; background:#0b0f1a; color:#b9c5e0; }

  /* 新增样式 */
  .stats-panel{ background:#0a0f1a; border:1px solid var(--line); border-radius:12px; padding:12px; margin-top:10px; }
  .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:10px; }
  .stat-item{ text-align:center; }
  .stat-value{ font-size:18px; font-weight:600; color:var(--accent); }
  .stat-label{ font-size:12px; color:var(--muted); margin-top:4px; }
  
  .loading{ display:inline-block; width:20px; height:20px; border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }
  
  .toast{ position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:var(--panel); border:1px solid var(--line); padding:12px 20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); z-index:100; }
  
  .help-shortcuts{ position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:var(--panel); border:1px solid var(--line); padding:20px; border-radius:12px; max-width:400px; width:90%; z-index:100; display:none; }
  .help-shortcuts h3{ margin-top:0; }
  .shortcut-item{ display:flex; justify-content:space-between; margin-bottom:10px; }
  .shortcut-keys{ display:flex; gap:4px; }
  .shortcut-key{ background:#0a0f1a; border:1px solid var(--line); padding:4px 8px; border-radius:6px; font-size:12px; }
  
  .overlay{ position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); z-index:99; display:none; }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>聊天记录查看/导出</h1>
    <span class="pill" id="status">未加载</span>
    <div class="spacer"></div>
    <label class="btn ghost" for="fileInput">导入</label>
    <input id="fileInput" type="file" accept=".json,.jsonl,.txt" hidden />
    <button class="btn" id="pasteBtn">粘贴</button>
    <button class="btn" id="clearBtn">清空</button>
    <button class="btn" id="helpBtn">帮助</button>
  </header>

  <main>
    <!-- 列表 -->
    <aside>
      <div class="toolbar">
        <div class="row">
          <input id="search" type="search" placeholder="搜索：内容 / ID / 会话ID" inputmode="search" />
        </div>
        <div class="row">
          <select id="roleFilter">
            <option value="">角色：全部</option>
            <option value="user">仅 user</option>
            <option value="assistant">仅 assistant</option>
            <option value="system">仅 system</option>
            <option value="tool">仅 tool</option>
          </select>
          <select id="convFilter">
            <option value="">会话：全部</option>
          </select>
        </div>
        <div class="row">
          <input id="dateFrom" type="text" placeholder="起始日期 YYYY-MM-DD" inputmode="numeric" />
          <input id="dateTo" type="text" placeholder="结束日期 YYYY-MM-DD" inputmode="numeric" />
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap;">
          <label class="toggle"><input type="checkbox" id="hideSystem" checked>隐藏 system</label>
          <label class="toggle"><input type="checkbox" id="hideTool" checked>隐藏 tool</label>
          <label class="toggle"><input type="checkbox" id="exactSearch">精确匹配</label>
        </div>
        <div class="drop" id="dropzone">拖拽 .json / .jsonl 到此导入</div>
        
        <!-- 统计面板 -->
        <div class="stats-panel" id="statsPanel" style="display:none;">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="statTotal">0</div>
              <div class="stat-label">总消息数</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statUser">0</div>
              <div class="stat-label">用户消息</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statAssistant">0</div>
              <div class="stat-label">助手消息</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="statConversations">0</div>
              <div class="stat-label">会话数</div>
            </div>
          </div>
        </div>
      </div>

      <div class="list" id="list"></div>

      <div class="countbar">
        <div id="countText">0 条</div>
        <div class="right">
          <button class="btn" id="selectAllBtn">全选筛选结果</button>
          <button class="btn" id="clearSelBtn">清除勾选</button>
        </div>
      </div>
    </aside>

    <!-- 聊天视图 -->
    <section class="viewer">
      <div class="chatHead">
        <span class="badge" id="viewRole">—</span>
        <div class="meta">
          <span id="viewId">ID: —</span>
          <span id="viewConv">会话: —</span>
          <span id="viewTs">时间: —</span>
        </div>
        <div class="spacer"></div>
        <button class="btn" id="copyBtn" disabled>复制此条</button>
        <button class="btn" id="exportOneBtn" disabled>导出此条</button>
      </div>

      <div class="chat" id="chat">
        <div class="day">左侧点一条消息查看。默认仅显示该条；可在底部开启"显示回溯"。</div>
      </div>

      <div class="chatFoot">
        <label class="chip"><input type="checkbox" id="showContext"> 显示回溯</label>
        <div class="range">
          <label for="ctxRange">回溯条数</label>
          <input id="ctxRange" type="range" min="1" max="50" step="1" value="8" />
          <span id="ctxNum">8</span>
        </div>
        <label class="chip"><input type="checkbox" id="onlyThisConv"> 只看此会话</label>

        <div class="footRight">
          <button class="btn primary" id="exportJSONL" disabled>导出 JSONL</button>
          <button class="btn" id="exportCSV" disabled>CSV</button>
          <button class="btn" id="exportMD" disabled>MD</button>
          <button class="btn" id="exportTXT" disabled>TXT</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- 帮助弹窗 -->
<div class="overlay" id="helpOverlay"></div>
<div class="help-shortcuts" id="helpShortcuts">
  <h3>键盘快捷键</h3>
  <div class="shortcut-item">
    <span>上下导航</span>
    <div class="shortcut-keys">
      <span class="shortcut-key">↑</span>
      <span class="shortcut-key">↓</span>
    </div>
  </div>
  <div class="shortcut-item">
    <span>选择/取消选择</span>
    <div class="shortcut-keys">
      <span class="shortcut-key">Space</span>
    </div>
  </div>
  <div class="shortcut-item">
    <span>全选/取消全选</span>
    <div class="shortcut-keys">
      <span class="shortcut-key">Ctrl</span>
      <span class="shortcut-key">A</span>
    </div>
  </div>
  <div class="shortcut-item">
    <span>搜索</span>
    <div class="shortcut-keys">
      <span class="shortcut-key">Ctrl</span>
      <span class="shortcut-key">F</span>
    </div>
  </div>
  <div class="shortcut-item">
    <span>关闭帮助</span>
    <div class="shortcut-keys">
      <span class="shortcut-key">Esc</span>
    </div>
  </div>
  <button class="btn" style="width:100%; margin-top:15px;" id="closeHelpBtn">关闭</button>
</div>

<script>
(() => {
  // -------- State --------
  let all = [];         // 扁平消息
  let filtered = [];    // 当前筛选
  let selectedIds = new Set();
  let currentIndex = -1;

  const $ = id => document.getElementById(id);
  const $list = $('list'), $chat = $('chat');

  // -------- Helpers --------
  const parseDate = v => {
    if (v == null || v === '') return null;
    if (typeof v === 'number'){ const ms = v < 2e10 ? v*1000 : v; return new Date(ms); }
    const d = new Date(v); return isNaN(d.getTime()) ? null : d;
  };
  const fmtDate = d => d ? d.toISOString().replace('T',' ').slice(0,19) : '—';

  const readFile = file => new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onerror = () => rej(fr.error);
    fr.onload = () => res(fr.result);
    fr.readAsText(file);
  });

  const dl = (name, content, type='text/plain;charset=utf-8')=>{
    const blob = new Blob([content], {type});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  };

  const showToast = (message, duration=3000) => {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.3s ease';
      setTimeout(() => {
        if (toast.parentNode) document.body.removeChild(toast);
      }, 300);
    }, duration);
  };

  const normalize = (raw, i=0)=>{
    let id = raw.id ?? raw.message_id ?? `row_${i}`;
    let role = String(raw.role ?? raw.author ?? raw.sender ?? '').toLowerCase();
    let conv = raw.conversation_id ?? raw.thread_id ?? raw.session_id ?? '';
    let ts = raw.created_at ?? raw.create_time ?? raw.time ?? raw.timestamp ?? null;
    let created_at = parseDate(ts);
    let text = '';

    if (typeof raw.content === 'string') text = raw.content;
    else if (raw.content && typeof raw.content === 'object'){
      try{
        if (Array.isArray(raw.content)){
          text = raw.content.map(p=>{
            if (typeof p === 'string') return p;
            if (p?.text?.value) return p.text.value;
            if (p?.text) return p.text;
            if (p?.type==='text' && p.text?.value) return p.text.value;
            return JSON.stringify(p);
          }).join('\n');
        } else if (raw.content?.text?.value) text = raw.content.text.value;
        else if (raw.content?.parts) text = raw.content.parts.join('\n');
        else text = JSON.stringify(raw.content);
      }catch{ text = String(raw.content) }
    } else if (raw.text) text = raw.text;
    else if (raw.body) text = raw.body;

    return {
      id:String(id), role, conversation_id:String(conv ?? ''),
      created_at, raw_time: ts ?? null, content:String(text ?? ''), _raw:raw
    };
  };

  const fromJSON = (obj)=>{
    if (Array.isArray(obj)) return obj;
    if (obj?.messages && Array.isArray(obj.messages)) return obj.messages;
    if (obj?.data && Array.isArray(obj.data)) return obj.data;
    if (obj?.conversations && Array.isArray(obj.conversations)){
      return obj.conversations.flatMap(c => (c.messages||[]).map(m => ({...m, conversation_id: c.id ?? c.conversation_id ?? ''})));
    }
    return [obj];
  };

  const roleBadgeClass = r => {
    if (r==='user') return 'badge user';
    if (r==='assistant') return 'badge assistant';
    if (r==='system') return 'badge system';
    if (r==='tool') return 'badge tool';
    return 'badge';
  };
  const bubbleClass = r => {
    if (r==='user') return 'bubble user';
    if (r==='assistant') return 'bubble assistant';
    if (r==='system') return 'bubble system';
    if (r==='tool') return 'bubble tool';
    return 'bubble';
  };
  const rowClass = r => {
    if (r==='user') return 'rowU';
    if (r==='assistant') return 'rowA';
    if (r==='system') return 'rowS';
    if (r==='tool') return 'rowT';
    return 'rowA';
  };

  // -------- 统计功能 --------
  const updateStats = () => {
    if (all.length === 0) {
      $('statsPanel').style.display = 'none';
      return;
    }
    
    $('statsPanel').style.display = 'block';
    
    // 计算统计数据
    const total = all.length;
    const userCount = all.filter(m => m.role === 'user').length;
    const assistantCount = all.filter(m => m.role === 'assistant').length;
    const conversations = new Set(all.map(m => m.conversation_id).filter(Boolean)).size;
    
    // 更新UI
    $('statTotal').textContent = total;
    $('statUser').textContent = userCount;
    $('statAssistant').textContent = assistantCount;
    $('statConversations').textContent = conversations;
  };

  // -------- List render --------
  const refreshList = ()=>{
    $list.innerHTML = '';
    const frag = document.createDocumentFragment();
    filtered.forEach((m,i)=>{
      const row = document.createElement('div'); 
      row.className = currentIndex === i ? 'msg selected' : 'msg'; 
      row.tabIndex = 0;

      const ck = document.createElement('input'); ck.type='checkbox'; ck.className='ck';
      ck.checked = selectedIds.has(m.id);
      ck.addEventListener('change',e=>{
        if (e.target.checked) selectedIds.add(m.id); else selectedIds.delete(m.id);
        updateExportButtons();
      });

      const badge = document.createElement('span'); badge.className=roleBadgeClass(m.role); badge.textContent=m.role||'—';
      const mid = document.createElement('div'); mid.className='pv';
      mid.title = `ID:${m.id} / 会话:${m.conversation_id||'—'}`;
      mid.textContent = (m.content||'').replace(/\s+/g,' ').slice(0,160);

      const right = document.createElement('div'); right.className='ts'; right.textContent=fmtDate(m.created_at);

      row.appendChild(ck); row.appendChild(badge); row.appendChild(mid); row.appendChild(right);
      row.addEventListener('click', (ev)=>{ 
        if (ev.target.tagName.toLowerCase()==='input') return; 
        viewAt(i); 
      });
      row.addEventListener('keydown', e=>{ 
        if (e.key==='Enter') viewAt(i); 
        if (e.key===' ') {
          e.preventDefault();
          if (selectedIds.has(m.id)) {
            selectedIds.delete(m.id);
            ck.checked = false;
          } else {
            selectedIds.add(m.id);
            ck.checked = true;
          }
          updateExportButtons();
        }
      });
      frag.appendChild(row);
    });
    $list.appendChild(frag);
    $('countText').textContent = `${filtered.length} 条`;
  };

  // -------- Chat render (single / with context window) --------
  const renderChat = ()=>{
    $chat.innerHTML = '';
    if (currentIndex<0 || currentIndex>=filtered.length){
      const d = document.createElement('div'); d.className='day'; d.textContent='未选择消息';
      $chat.appendChild(d); return;
    }
    const m = filtered[currentIndex];
    const showCtx = $('showContext').checked;
    const win = parseInt($('ctxRange').value || '8', 10);

    let toShow = [m];
    if (showCtx){
      // 仅同会话，限定回溯窗口（避免"全量摊开"）
      const conv = m.conversation_id;
      const inConv = filtered.filter(x=> x.conversation_id === conv);
      const idx = inConv.findIndex(x=>x.id===m.id);
      const start = Math.max(idx - win, 0);
      const end = Math.min(idx + win + 1, inConv.length);
      toShow = inConv.slice(start, end);
    }

    // 分日显示
    let lastDay = '';
    toShow.forEach(msg=>{
      const day = msg.created_at ? msg.created_at.toISOString().slice(0,10) : '';
      if (day && day!==lastDay){
        const sep = document.createElement('div'); sep.className='day'; sep.textContent = day;
        $chat.appendChild(sep); lastDay = day;
      }
      const row = document.createElement('div'); row.className = rowClass(msg.role);
      const bubble = document.createElement('div'); bubble.className = bubbleClass(msg.role);
      bubble.textContent = msg.content || '（空）';

      const who = document.createElement('div'); who.className='who';
      who.textContent = `[${msg.role||'—'}] ${fmtDate(msg.created_at)}`;

      if (row.className==='rowU'){
        row.appendChild(who); row.appendChild(bubble);
      } else {
        row.appendChild(bubble); row.appendChild(who);
      }
      $chat.appendChild(row);
    });

    // 滚到底部（更像聊天）
    requestAnimationFrame(()=>{ $chat.scrollTop = $chat.scrollHeight + 9999; });
  };

  const viewAt = (i)=>{
    if (i<0 || i>=filtered.length) return;
    currentIndex = i;
    const m = filtered[i];

    // 头信息
    $('viewRole').className = roleBadgeClass(m.role);
    $('viewRole').textContent = m.role || '—';
    $('viewId').textContent = `ID: ${m.id}`;
    $('viewConv').textContent = `会话: ${m.conversation_id || '—'}`;
    $('viewTs').textContent = `时间: ${fmtDate(m.created_at)}${m.raw_time && !m.created_at ? `（原始：${m.raw_time}）` : ''}`;

    $('copyBtn').disabled = false;
    $('exportOneBtn').disabled = false;

    if ($('onlyThisConv').checked && m.conversation_id){
      $('convFilter').value = m.conversation_id;
      applyFilters(false); // 保持当前选中后再渲染
      // 重算后找到同一条
      const ix = filtered.findIndex(x=>x.id===m.id);
      currentIndex = ix >=0 ? ix : 0;
    }
    renderChat();
    refreshList(); // 更新选中状态
  };

  const updateExportButtons = ()=>{
    const any = selectedIds.size > 0;
    $('exportJSONL').disabled = !any;
    $('exportCSV').disabled   = !any;
    $('exportMD').disabled    = !any;
    $('exportTXT').disabled   = !any;
  };

  // -------- Filters --------
  const applyFilters = (resetIndex=true)=>{
    const q = $('search').value.trim().toLowerCase();
    const role = $('roleFilter').value;
    const conv = $('convFilter').value;
    const hideSystem = $('hideSystem').checked;
    const hideTool = $('hideTool').checked;
    const exact = $('exactSearch').checked;

    const df = $('dateFrom').value.trim();
    const dt = $('dateTo').value.trim();
    const from = df ? new Date(df+'T00:00:00') : null;
    const to   = dt ? new Date(dt+'T23:59:59') : null;

    filtered = all.filter(m=>{
      if (hideSystem && m.role==='system') return false;
      if (hideTool && m.role==='tool') return false;
      if (role && m.role!==role) return false;
      if (conv && m.conversation_id!==conv) return false;
      if (from && (!m.created_at || m.created_at < from)) return false;
      if (to && (!m.created_at || m.created_at > to)) return false;
      if (q){
        const hay = (m.content + ' ' + m.id + ' ' + m.conversation_id).toLowerCase();
        if (exact ? !hay.includes(q)
                  : q.split(/\s+/).filter(Boolean).some(p=>!hay.includes(p))) return false;
      }
      return true;
    });

    refreshList();
    updateExportButtons();
    if (resetIndex){ currentIndex = -1; $chat.innerHTML='<div class="day">筛选完成，选择一条查看。</div>'; }
  };

  const fillConv = ()=>{
    const sel = $('convFilter'); const keep = sel.value;
    const set = new Set(all.map(m=>m.conversation_id).filter(Boolean));
    sel.innerHTML = '<option value="">会话：全部</option>';
    Array.from(set).sort().forEach(id=>{
      const o=document.createElement('option'); o.value=id; o.textContent=id; sel.appendChild(o);
    });
    if (set.has(keep)) sel.value = keep;
  };

  // -------- Import --------
  const loadRecords = (records)=>{
    all = records.map((r,i)=>normalize(r,i));
    selectedIds.clear(); currentIndex=-1;
    fillConv(); applyFilters();
    $('status').textContent = `已载入 ${all.length} 条`;
    updateStats();
    showToast(`成功导入 ${all.length} 条消息`);
  };

  const importText = (text)=>{
    const looksJSONL = text.split('\n').filter(l=>l.trim()).length>1 && text.trim()[0]!=='[';
    try{
      if (looksJSONL){
        const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
        const arr = [];
        for (const line of lines){ try{ arr.push(JSON.parse(line)); }catch{} }
        loadRecords(arr.flatMap(o=>fromJSON(o)));
      }else{
        const obj = JSON.parse(text);
        loadRecords(fromJSON(obj));
      }
    }catch(e){ alert('解析失败：请检查是否为有效 JSON/JSONL。\n\n'+e.message); }
  };

  // -------- Export --------
  const pick = ()=>{
    const map = new Map(all.map(x=>[x.id,x]));
    return Array.from(selectedIds).map(id=>map.get(id)).filter(Boolean);
  };
  const toJSONL = rows =>
    rows.map(r=>JSON.stringify({ id:r.id, role:r.role, conversation_id:r.conversation_id,
      created_at: r.created_at? r.created_at.toISOString() : (r.raw_time??null), content:r.content })).join('\n');
  const toCSV = rows => {
    const esc = s => `"${String(s??'').replace(/"/g,'""').replace(/\r?\n/g,'\\n')}"`;
    const head = ['id','role','conversation_id','created_at','content'];
    const lines = [head.join(',')];
    rows.forEach(r=>{
      lines.push([esc(r.id),esc(r.role),esc(r.conversation_id),
        esc(r.created_at? r.created_at.toISOString() : (r.raw_time??'')), esc(r.content)].join(','));
    });
    return lines.join('\n');
  };
  const toMD = rows => rows.map(r=>{
    const ts = r.created_at? r.created_at.toISOString() : (r.raw_time??'—');
    return `### ${r.role||'—'} · ${ts}\n- ID: \`${r.id}\`\n- 会话: \`${r.conversation_id||'—'}\`\n\n${r.content||''}\n`;
  }).join('\n---\n\n');
  const toTXT = rows => rows.map(r=>{
    const ts = r.created_at? r.created_at.toISOString() : (r.raw_time??'—');
    return `[${r.role||'—'}] (${ts}) {id:${r.id}} {conv:${r.conversation_id||'—'}}\n${r.content||''}\n`;
  }).join('\n------------------------------\n\n');

  // -------- Events --------
  $('fileInput').addEventListener('change', async e=>{
    const f = e.target.files?.[0]; if (!f) return;
    $('status').textContent = `读取 ${f.name}…`;
    const txt = await readFile(f); importText(txt); e.target.value='';
  });
  $('pasteBtn').addEventListener('click', async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      if (!t){ alert('剪贴板为空'); return; }
      importText(t);
    }catch{
      const t = prompt('无法直接读剪贴板，请粘贴 JSON/JSONL 文本：');
      if (t) importText(t);
    }
  });
  $('clearBtn').addEventListener('click', ()=>{
    if (all.length === 0 || confirm('确定要清空所有数据吗？')) {
      all=[]; filtered=[]; selectedIds.clear(); currentIndex=-1;
      $list.innerHTML=''; $chat.innerHTML='<div class="day">已清空</div>';
      $('status').textContent='未加载'; fillConv(); updateExportButtons(); $('countText').textContent='0 条';
      updateStats();
      showToast('数据已清空');
    }
  });

  // 拖拽导入
  const dz = $('dropzone');
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.style.background='#0d1220'; });
  dz.addEventListener('dragleave', ()=>{ dz.style.background='#0a0f1a'; });
  dz.addEventListener('drop', async e=>{
    e.preventDefault(); dz.style.background='#0a0f1a';
    const f = e.dataTransfer.files?.[0]; if (!f) return;
    const t = await readFile(f); importText(t);
  });

  // 筛选
  ['search','roleFilter','convFilter','dateFrom','dateTo','hideSystem','hideTool','exactSearch']
  .forEach(id=>{
    $(id).addEventListener('input', ()=>applyFilters());
    $(id).addEventListener('change', ()=>applyFilters());
  });

  // 选择
  $('selectAllBtn').addEventListener('click', ()=>{ filtered.forEach(m=>selectedIds.add(m.id)); refreshList(); updateExportButtons(); showToast(`已选择 ${filtered.length} 条消息`); });
  $('clearSelBtn').addEventListener('click', ()=>{ selectedIds.clear(); refreshList(); updateExportButtons(); showToast('已清除选择'); });

  // 底部控件
  $('showContext').addEventListener('change', renderChat);
  $('ctxRange').addEventListener('input', ()=>{ $('ctxNum').textContent = $('ctxRange').value; renderChat(); });
  $('onlyThisConv').addEventListener('change', ()=>{
    if (currentIndex>=0) viewAt(currentIndex); // 触发过滤/重渲染
  });

  // 单条操作
  $('copyBtn').addEventListener('click', ()=>{
    if (currentIndex<0) return;
    const m = filtered[currentIndex];
    const text = `[${m.role}] (${fmtDate(m.created_at)}) {id:${m.id}} {conv:${m.conversation_id||'—'}}\n${m.content||''}`;
    navigator.clipboard.writeText(text);
    showToast('消息已复制到剪贴板');
  });
  $('exportOneBtn').addEventListener('click', ()=>{
    if (currentIndex<0) return;
    const one = toJSONL([filtered[currentIndex]]);
    dl(`message_${filtered[currentIndex].id}.jsonl`, one);
    showToast('单条消息已导出');
  });

  // 批量导出
  $('exportJSONL').addEventListener('click', ()=>{ const rows = pick(); if (!rows.length) return; dl(`messages_${rows.length}.jsonl`, toJSONL(rows)); showToast(`已导出 ${rows.length} 条消息为 JSONL`); });
  $('exportCSV').addEventListener('click', ()=>{ const rows = pick(); if (!rows.length) return; dl(`messages_${rows.length}.csv`, toCSV(rows), 'text/csv;charset=utf-8'); showToast(`已导出 ${rows.length} 条消息为 CSV`); });
  $('exportMD').addEventListener('click',  ()=>{ const rows = pick(); if (!rows.length) return; dl(`messages_${rows.length}.md`,  toMD(rows), 'text/markdown;charset=utf-8'); showToast(`已导出 ${rows.length} 条消息为 Markdown`); });
  $('exportTXT').addEventListener('click', ()=>{ const rows = pick(); if (!rows.length) return; dl(`messages_${rows.length}.txt`, toTXT(rows)); showToast(`已导出 ${rows.length} 条消息为 TXT`); });

  // 帮助功能
  $('helpBtn').addEventListener('click', () => {
    $('helpShortcuts').style.display = 'block';
    $('helpOverlay').style.display = 'block';
  });
  
  $('closeHelpBtn').addEventListener('click', () => {
    $('helpShortcuts').style.display = 'none';
    $('helpOverlay').style.display = 'none';
  });
  
  $('helpOverlay').addEventListener('click', () => {
    $('helpShortcuts').style.display = 'none';
    $('helpOverlay').style.display = 'none';
  });

  // 轻量"记忆"上次设置
  const savePrefs = ()=>{
    const p = {
      hideSystem:$('hideSystem').checked, hideTool:$('hideTool').checked, exact:$('exactSearch').checked,
      showContext:$('showContext').checked, ctxRange:$('ctxRange').value
    };
    try{ localStorage.setItem('chat_viewer_prefs', JSON.stringify(p)); }catch{}
  };
  const loadPrefs = ()=>{
    try{
      const p = JSON.parse(localStorage.getItem('chat_viewer_prefs')||'{}');
      if ('hideSystem' in p) $('hideSystem').checked = p.hideSystem;
      if ('hideTool' in p) $('hideTool').checked = p.hideTool;
      if ('exact' in p) $('exactSearch').checked = p.exact;
      if ('showContext' in p) $('showContext').checked = p.showContext;
      if ('ctxRange' in p){ $('ctxRange').value = p.ctxRange; $('ctxNum').textContent = p.ctxRange; }
    }catch{}
  };
  document.addEventListener('change', savePrefs);
  document.addEventListener('input', savePrefs);
  loadPrefs();

  // 键盘（连蓝牙键盘也能用）
  document.addEventListener('keydown', e=>{
    if (!filtered.length) return;
    
    // 帮助快捷键
    if (e.key === 'F1' || (e.ctrlKey && e.key === '/')) {
      e.preventDefault();
      $('helpShortcuts').style.display = 'block';
      $('helpOverlay').style.display = 'block';
      return;
    }
    
    // 关闭帮助
    if (e.key === 'Escape') {
      $('helpShortcuts').style.display = 'none';
      $('helpOverlay').style.display = 'none';
      return;
    }
    
    // 全选
    if (e.ctrlKey && e.key === 'a') {
      e.preventDefault();
      filtered.forEach(m=>selectedIds.add(m.id)); 
      refreshList(); 
      updateExportButtons();
      showToast(`已选择 ${filtered.length} 条消息`);
      return;
    }
    
    // 搜索
    if (e.ctrlKey && e.key === 'f') {
      e.preventDefault();
      $('search').focus();
      return;
    }
    
    if (e.key === 'ArrowDown'){ e.preventDefault(); const next = Math.min((currentIndex<0?0:currentIndex+1), filtered.length-1); ensureRowVisible(next); viewAt(next); }
    if (e.key === 'ArrowUp'){ e.preventDefault(); const prev = Math.max((currentIndex<0?0:currentIndex-1), 0); ensureRowVisible(prev); viewAt(prev); }
  });
  const ensureRowVisible = (idx)=>{
    const rows = $list.querySelectorAll('.msg'); const el = rows[idx]; if (!el) return;
    const r = el.getBoundingClientRect(), lr = $list.getBoundingClientRect();
    if (r.top < lr.top) $list.scrollTop -= (lr.top - r.top + 8);
    if (r.bottom > lr.bottom) $list.scrollTop += (r.bottom - lr.bottom + 8);
  };
})();
</script>
</body>
</html>
