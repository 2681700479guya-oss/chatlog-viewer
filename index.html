<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>ChatGPT 聊天记录查看器</title>
<style>
:root{
  --bg-light:#f6f6f7; --bg-dark:#1b1b1f;
  --text-light:#0f1115; --text-dark:#e7e7ea;
  --user:#0a84ff; --assistant:#5e5e66; --sys:#9b59b6;
  --chip:#d0d5dd22; --border:#00000014; --border-dark:#ffffff22;
  --sidebar-bg-light:#ffffff; --sidebar-bg-dark:#232329;
  --panel-bg-light:#ffffffee; --panel-bg-dark:#232329ee;
  --bubble-max:86%;
  --header-h:48px; /* 运行时按实际高度覆盖 */
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;background:var(--bg-light);color:var(--text-light);transition:.25s}
body.dark{background:var(--bg-dark);color:var(--text-dark)}

/* 更薄的顶栏（含控制台开关） */
header{
  position:sticky;top:0;z-index:70;backdrop-filter:saturate(180%) blur(8px);
  background:color-mix(in oklab,currentColor 6%,transparent);
  display:flex;gap:.5rem;align-items:center;justify-content:space-between;
  padding:.35rem .7rem;border-bottom:1px solid var(--border)
}
body.dark header{border-bottom-color:var(--border-dark)}
h1{font-size:.95rem;margin:0;font-weight:600;display:flex;gap:.45rem;align-items:center}
.controls{display:flex;gap:.35rem;align-items:center;white-space:nowrap;flex-wrap:nowrap}
button,select,input[type="range"],input[type="text"]{
  padding:.38rem .6rem;border-radius:9px;border:1px solid var(--border);
  background:#fff;color:#111;cursor:pointer;font-size:.85rem
}
body.dark button,body.dark select,body.dark input[type="range"],body.dark input[type="text"]{
  background:#2a2a31;color:var(--text-dark);border-color:var(--border-dark)
}
button:active{transform:scale(.98)}
input[type=file]{display:none}
.icon{font-size:1rem}

/* 控制台（固定，默认收起，通过顶栏按钮开合） */
.panel-fixed{position:fixed;left:0;right:0;top:var(--header-h);z-index:60;display:none}
.panel-fixed.open{display:block}
.panel{background:var(--panel-bg-light);backdrop-filter:saturate(180%) blur(6px);border-bottom:1px solid var(--border)}
body.dark .panel{background:var(--panel-bg-dark);border-bottom-color:var(--border-dark)}
.panel-content{padding:.6rem .8rem}
.group{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap;margin:.2rem 0}
.badge{padding:.15rem .45rem;border-radius:7px;border:1px solid var(--border);font-size:.76rem;opacity:.9}
body.dark .badge{border-color:var(--border-dark)}
.colorbox{display:flex;gap:.45rem;align-items:center}
.colorbox label{font-size:.8rem;opacity:.85}
.colorbox input[type=color]{width:30px;height:26px;padding:0;border:none;background:transparent}
/* 控制台占位（动态高度） */
.panel-spacer{height:0}

/* 布局：侧边栏 + 内容 */
.layout{display:flex}
.sidebar{
  position:fixed;left:0;top:var(--header-h);
  height:calc(100dvh - var(--header-h));
  width:280px;background:var(--sidebar-bg-light);color:inherit;border-right:1px solid var(--border);
  transform:translateX(-100%);transition:transform .25s ease;z-index:55;display:flex;flex-direction:column
}
body.dark .sidebar{background:var(--sidebar-bg-dark);border-right-color:var(--border-dark)}
.sidebar.open{transform:translateX(0)}
.sidebar .side-head{padding:.7rem .8rem;border-bottom:1px solid var(--border)}
body.dark .sidebar .side-head{border-bottom-color:var(--border-dark)}
.sidebar .list{overflow:auto;padding:.45rem}
.conv-item{padding:.55rem .65rem;border-radius:10px;margin:.25rem 0;cursor:pointer;border:1px solid transparent}
.conv-item:hover{background:color-mix(in oklab,currentColor 6%,transparent)}
.conv-item.active{border-color:var(--border-dark)}
.meta-mini{font-size:.74rem;opacity:.7;margin-top:.18rem}

/* 遮罩 */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.2);backdrop-filter:blur(1px);
  opacity:0;pointer-events:none;transition:.2s;z-index:50}
.backdrop.show{opacity:1;pointer-events:auto}

/* 主内容容器：宽度自适应但不影响两侧对齐 */
.container{
  padding:.8rem;display:flex;flex-direction:column;gap:.75rem;
  width:100%;max-width:980px;margin:0 auto;
}
.chat{
  display:flex;flex-direction:column;gap:.75rem;
  width:100%;
}

/* 气泡与“固定左右”策略 */
.msg{
  max-width:var(--bubble-max);
  padding:.58rem .78rem;border-radius:14px;white-space:pre-wrap;line-height:1.55
}
/* 关键：通过 margin 自动推挤，保证用户气泡永远贴右，助手贴左 —— 放大/缩小时不“挪边” */
.msg.user{background:var(--user);color:#fff;margin-left:auto}
.msg.assistant{background:var(--assistant);color:#fff;margin-right:auto}
.msg.system{background:var(--sys);color:#fff;margin-left:auto;margin-right:auto}

.name{font-size:.75rem;opacity:.8;margin:0 .18rem .18rem .18rem}
.meta-top{font-size:.75rem;opacity:.85;margin:.05rem .18rem;display:flex;gap:.45rem;flex-wrap:wrap}
.model-chip{padding:.08rem .4rem;border-radius:999px;background:var(--chip)}
/* 与气泡对齐的“推挤” */
.align-right{margin-left:auto;text-align:right}
.align-left{margin-right:auto;text-align:left}
.align-center{margin-left:auto;margin-right:auto;text-align:center}

/* 分支（回溯）——默认收起，更明显 */
.branch{
  margin:.5rem 0 .2rem 0;border-radius:12px;
  background:color-mix(in oklab,currentColor 8%,transparent);
  border-left:4px solid var(--assistant);
  box-shadow:inset 0 0 0 1px color-mix(in oklab,currentColor 10%,transparent);
  padding:.3rem .6rem;
}
body.dark .branch{
  background:color-mix(in oklab,currentColor 12%,transparent);
  border-left-color:var(--assistant);
}
.branch summary{
  cursor:pointer;list-style:none;display:flex;align-items:center;gap:.5rem;
  font-size:.78rem;opacity:.95;padding:.25rem 0
}
.branch summary::-webkit-details-marker{display:none}
.branch .branch-badge{font-size:.72rem;padding:.1rem .45rem;border-radius:999px;background:var(--chip)}
.branch-thread{display:flex;flex-direction:column;gap:.55rem;margin:.4rem .1rem .55rem .25rem}
.branch .msg{max-width:calc(var(--bubble-max) - 6%)} /* 分支略窄 */
.branch .name,.branch .meta-top{opacity:.82}

/* 批量导出弹窗 */
.modal{position:fixed;inset:0;z-index:90;display:none;align-items:center;justify-content:center}
.modal.show{display:flex}
.modal .mask{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px)}
.modal .card{
  position:relative;z-index:1;max-width:92vw;width:680px;max-height:82vh;overflow:auto;
  background:var(--sidebar-bg-light);color:inherit;border:1px solid var(--border);border-radius:12px;padding:.8rem
}
body.dark .modal .card{background:var(--sidebar-bg-dark);border-color:var(--border-dark)}
.modal .title{font-weight:600;margin-bottom:.5rem}
.modal .list{display:flex;flex-direction:column;gap:.35rem}
.modal .row{display:flex;align-items:center;gap:.5rem;border:1px solid var(--border);border-radius:9px;padding:.45rem}
body.dark .modal .row{border-color:var(--border-dark)}
.modal .foot{display:flex;gap:.5rem;justify-content:flex-end;margin-top:.7rem}

/* 错误提示条 */
.errbar{position:fixed;left:0;right:0;bottom:0;z-index:95;background:#c0392b;color:#fff;padding:.55rem .85rem;display:none}
.errbar.show{display:block}

/* 宽屏常驻侧栏 */
@media (min-width:1100px){
  .sidebar{transform:translateX(0)}
  .backdrop{display:none}
  .container{margin-left:280px}
}
</style>
</head>
<body>
<header id="siteHeader">
  <h1><button id="burger" class="icon" aria-label="菜单">☰</button>📄 ChatGPT 聊天记录查看器</h1>
  <div class="controls">
    <input id="file" type="file" accept=".json" />
    <button onclick="pickFile()">导入</button>
    <button onclick="exportCurrentConversation()">导出当前</button>
    <button onclick="openBatchModal()">批量导出</button>
    <button id="togglePanelBtn">展开控制台</button>
    <button onclick="toggleTheme()">夜间/日间</button>
  </div>
</header>

<!-- 控制台（默认收起，无总字数显示） -->
<div class="panel-fixed" id="panelWrap">
  <div class="panel">
    <div class="panel-content">
      <div class="group">
        <span class="badge">会话：</span>
        <select id="convListTop" onchange="selectConversation(this.value)"></select>
        <span class="badge" id="convMeta" title="创建时间 / 消息数 / 字数"></span>
      </div>
      <div class="group">
        <span class="badge">外观：</span>
        <div class="colorbox">
          <label>用户</label><input type="color" id="cUser">
          <label>助手</label><input type="color" id="cAssistant">
          <label>系统</label><input type="color" id="cSystem">
        </div>
        <span class="badge">气泡宽度：</span>
        <input type="range" id="bubbleWidth" min="60" max="100" value="86" oninput="setBubbleWidth(this.value)">
        <span id="bubbleVal" class="badge" style="opacity:.7">86%</span>
        <button onclick="resetTheme()">恢复默认</button>
      </div>
      <div class="group">
        <span class="badge">显示名：</span>
        <input id="nameUser" type="text" placeholder="用户显示名" style="width:8.2rem">
        <input id="nameAssistant" type="text" placeholder="助手显示名" style="width:8.2rem">
        <input id="nameSystem" type="text" placeholder="系统显示名" style="width:8.2rem">
        <button onclick="saveNames()">保存</button>
      </div>
    </div>
  </div>
</div>
<div id="panelSpacer" class="panel-spacer"></div>

<div class="layout">
  <!-- 侧边栏 -->
  <aside class="sidebar" id="sidebar">
    <div class="side-head">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:.5rem">
        <strong>会话列表</strong>
        <button id="closeSidebar">关闭</button>
      </div>
      <div class="small" style="opacity:.6">导入 conversations.json 或单会话后显示</div>
    </div>
    <div class="list" id="convListSide"></div>
  </aside>
  <div class="backdrop" id="backdrop"></div>

  <!-- 主内容 -->
  <main class="container">
    <div id="chat" class="chat">
      <p style="opacity:.6;text-align:center">导入 ChatGPT 官方导出的会话 JSON（单个会话或 conversations.json）。</p>
    </div>
    <footer class="small" style="opacity:.75">离线运行｜分支（回溯）默认收起｜导出仅当前或批量多文件</footer>
  </main>
</div>

<!-- 批量导出弹窗 -->
<div class="modal" id="batchModal">
  <div class="mask" onclick="closeBatchModal()"></div>
  <div class="card">
    <div class="title">批量导出会话</div>
    <div class="list" id="batchList"></div>
    <div class="foot">
      <button onclick="selectAllBatch(true)">全选</button>
      <button onclick="selectAllBatch(false)">全不选</button>
      <button onclick="doBatchExport()">导出选中</button>
      <button onclick="closeBatchModal()">关闭</button>
    </div>
  </div>
</div>

<div id="err" class="errbar"></div>

<script>
/* ==== 元素 & 错误提示 ==== */
const errBar = document.getElementById('err');
function showErr(msg){ errBar.textContent = msg; errBar.classList.add('show'); setTimeout(()=>errBar.classList.remove('show'), 6000); }

const siteHeader = document.getElementById('siteHeader');
const panelWrap = document.getElementById('panelWrap');
const panelSpacer = document.getElementById('panelSpacer');
const toggleBtn = document.getElementById('togglePanelBtn');

/* ==== 偏好 & 主题 ==== */
let dark=false;
const PREF_KEY='chatviewer_prefs_v9';
const prefs=loadPrefs();
applyPrefs();
function toggleTheme(){try{dark=!dark;document.body.classList.toggle('dark',dark);prefs.dark=dark;savePrefs();}catch(e){showErr('切换主题失败：'+e.message)}}
function loadPrefs(){try{return JSON.parse(localStorage.getItem(PREF_KEY))||{};}catch{return{};}}
function savePrefs(){try{localStorage.setItem(PREF_KEY,JSON.stringify(prefs));}catch(e){showErr('保存偏好失败：'+e.message)}}
function setCSS(varName,val){document.documentElement.style.setProperty(varName,val);}

/* 偏好回填 */
function applyPrefs(){
  try{
    dark=!!prefs.dark;document.body.classList.toggle('dark',dark);
    if(prefs.colors){
      if(prefs.colors.user)setCSS('--user',prefs.colors.user);
      if(prefs.colors.assistant)setCSS('--assistant',prefs.colors.assistant);
      if(prefs.colors.sys)setCSS('--sys',prefs.colors.sys);
    }
    if(prefs.bubble){setCSS('--bubble-max',prefs.bubble+'%');}
    if(prefs.names){
      const u=document.getElementById('nameUser'); if(u) u.value=prefs.names.user||'';
      const a=document.getElementById('nameAssistant'); if(a) a.value=prefs.names.assistant||'';
      const s=document.getElementById('nameSystem'); if(s) s.value=prefs.names.system||'';
    }
    setPanelOpen(!!prefs.panelOpen);
    setTimeout(()=>{updateLayoutHeights();
      if(prefs.colors){
        if(prefs.colors.user)document.getElementById('cUser').value=prefs.colors.user;
        if(prefs.colors.assistant)document.getElementById('cAssistant').value=prefs.colors.assistant;
        if(prefs.colors.sys)document.getElementById('cSystem').value=prefs.colors.sys;
      }
      if(prefs.bubble){
        document.getElementById('bubbleWidth').value=Number(prefs.bubble);
        document.getElementById('bubbleVal').textContent=`${prefs.bubble}%`;
      }
    },0);
  }catch(e){showErr('应用偏好失败：'+e.message)}
}
function resetTheme(){
  try{
    ['--user','--assistant','--sys'].forEach(v=>document.documentElement.style.removeProperty(v));
    document.getElementById('cUser').value='#0a84ff';
    document.getElementById('cAssistant').value='#5e5e66';
    document.getElementById('cSystem').value='#9b59b6';
    setBubbleWidth(86);
    prefs.colors={user:'#0a84ff',assistant:'#5e5e66',sys:'#9b59b6'};
    prefs.bubble=86;
    prefs.names={user:'',assistant:'',system:''};
    document.getElementById('nameUser').value='';
    document.getElementById('nameAssistant').value='';
    document.getElementById('nameSystem').value='';
    savePrefs(); render(); updateLayoutHeights();
  }catch(e){showErr('恢复默认失败：'+e.message)}
}
document.getElementById('cUser').addEventListener('input',e=>{setCSS('--user',e.target.value);prefs.colors=prefs.colors||{};prefs.colors.user=e.target.value;savePrefs();});
document.getElementById('cAssistant').addEventListener('input',e=>{setCSS('--assistant',e.target.value);prefs.colors=prefs.colors||{};prefs.colors.assistant=e.target.value;savePrefs();});
document.getElementById('cSystem').addEventListener('input',e=>{setCSS('--sys',e.target.value);prefs.colors=prefs.colors||{};prefs.colors.sys=e.target.value;savePrefs();});
function setBubbleWidth(val){setCSS('--bubble-max',`${val}%`);document.getElementById('bubbleVal').textContent=`${val}%`;prefs.bubble=Number(val);savePrefs();}

/* 显示名 */
function saveNames(){
  try{
    prefs.names={
      user:document.getElementById('nameUser').value.trim(),
      assistant:document.getElementById('nameAssistant').value.trim(),
      system:document.getElementById('nameSystem').value.trim()
    };
    savePrefs(); render();
  }catch(e){showErr('保存显示名失败：'+e.message)}
}
function displayName(role){
  const n=prefs.names||{};
  if(role==='user')return n.user||'';
  if(role==='assistant')return n.assistant||'';
  if(role==='system')return n.system||'';
  return '';
}

/* 控制台开合（按钮在顶栏） */
toggleBtn.addEventListener('click', ()=> setPanelOpen(!panelWrap.classList.contains('open')));
function setPanelOpen(open){
  panelWrap.classList.toggle('open', open);
  toggleBtn.textContent = open ? '收起控制台' : '展开控制台';
  prefs.panelOpen = open; savePrefs();
  updateLayoutHeights();
}

/* 根据 header 实高 + 控制台高度，校正布局 */
function updateLayoutHeights(){
  const headerH = siteHeader.offsetHeight || 48;
  setCSS('--header-h', headerH + 'px');
  const contentH = panelWrap.classList.contains('open') ? (panelWrap.querySelector('.panel').offsetHeight || 0) : 0;
  panelSpacer.style.height = contentH + 'px';
  const top = headerH + contentH;
  const sb = document.getElementById('sidebar');
  sb.style.top = top + 'px';
  sb.style.height = `calc(100dvh - ${top}px)`;
}

/* ==== 文件导入 ==== */
function pickFile(){document.getElementById('file').click();}
document.getElementById('file').addEventListener('change',async(e)=>{
  const f=e.target.files?.[0]; if(!f)return;
  try{
    const raw=await f.text();
    let data; try{data=JSON.parse(raw);}catch{throw new Error('不是有效 JSON：请导入 ChatGPT 官方导出解压后的 JSON');}
    handleImportedJSON(data);
  }catch(err){ showErr(err.message||String(err)); }
});

/* ==== 侧边栏 ==== */
const sidebar=document.getElementById('sidebar');
const backdrop=document.getElementById('backdrop');
document.getElementById('burger').addEventListener('click',()=>openSidebar(true));
document.getElementById('closeSidebar').addEventListener('click',()=>openSidebar(false));
backdrop.addEventListener('click',()=>openSidebar(false));
function openSidebar(show){
  if(window.matchMedia('(min-width:1100px)').matches){return;}
  sidebar.classList.toggle('open',show);
  backdrop.classList.toggle('show',show);
}

/* ==== 批量导出弹窗 ==== */
const batchModal = document.getElementById('batchModal');
const batchList = document.getElementById('batchList');
function openBatchModal(){
  buildBatchList();
  batchModal.classList.add('show');
}
function closeBatchModal(){ batchModal.classList.remove('show'); }
function buildBatchList(){
  batchList.innerHTML='';
  conversations.forEach((c,idx)=>{
    const row=document.createElement('label'); row.className='row';
    row.innerHTML = `<input type="checkbox" data-idx="${idx}">
      <div style="flex:1">
        <div>${escapeHTML(c.title||`(无标题) ${idx+1}`)}</div>
        <div class="meta-mini">消息 ${c.messages.length}${c.created?` · ${new Date(c.created*1000).toLocaleDateString()}`:''} · 字数 ${c.totalChars||0}</div>
      </div>`;
    batchList.appendChild(row);
  });
}
function selectAllBatch(on){
  batchList.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked=!!on);
}

/* —— 真·批量导出（逐个触发，避免 iOS Safari 丢点击） —— */
async function doBatchExport(){
  const ids=[...batchList.querySelectorAll('input[type=checkbox]:checked')].map(cb=>Number(cb.dataset.idx));
  if(!ids.length){ showErr('请先选择要导出的会话'); return; }
  // iOS/Safari 对连续触发下载比较敏感：逐个延时 450ms
  for (const id of ids){
    exportConversationByIndex(id);
    // 小延时，确保下载对话框能依次弹出
    await new Promise(r=>setTimeout(r, 450));
  }
}

/* ==== 解析与状态 ==== */
let conversations=[]; // {id,title,created,messages:[...],totalChars:number}
let currentConvIndex=0;

function handleImportedJSON(data){
  try{
    conversations=[];
    if(Array.isArray(data)){
      data.forEach(obj=>{const c=parseConversation(obj);if(c)conversations.push(c);});
    }else if(data&&typeof data==='object'){
      if(data.items&&Array.isArray(data.items)){data.items.forEach(obj=>{const c=parseConversation(obj);if(c)conversations.push(c);});}
      else{const c=parseConversation(data);if(c)conversations.push(c);}
    }
    if(!conversations.length){throw new Error('没解析到会话。请选择 conversations.json 或 conversations/*.json');}

    conversations.forEach(c=>{
      c.totalChars = c.messages.reduce((acc,m)=>acc+(m.content?m.content.length:0),0);
    });

    buildTopSelect();
    buildSidebarList();

    currentConvIndex=0;
    setTopSelect('0');
    updateConvMeta();
    render();
    setPanelOpen(prefs.panelOpen ?? false);
    updateLayoutHeights();
  }catch(e){ showErr('导入失败：'+(e.message||e)); }
}

function buildTopSelect(){
  const sel=document.getElementById('convListTop'); sel.innerHTML='';
  conversations.forEach((c,idx)=>{
    const opt=document.createElement('option');
    opt.value=String(idx); opt.textContent=c.title||`(无标题) ${idx+1}`; sel.appendChild(opt);
  });
}
function setTopSelect(val){document.getElementById('convListTop').value=val;}

function buildSidebarList(){
  const list=document.getElementById('convListSide'); list.innerHTML='';
  conversations.forEach((c,idx)=>{
    const item=document.createElement('div');
    item.className='conv-item'+(idx===currentConvIndex?' active':'');
    const dateStr = c.created?new Date(c.created*1000).toLocaleDateString():'';
    item.innerHTML=`<div>${escapeHTML(c.title||`(无标题) ${idx+1}`)}</div>
      <div class="meta-mini">消息 ${c.messages.length}${dateStr?` · ${dateStr}`:''} · 字数 ${c.totalChars||0}</div>`;
    item.onclick=()=>{
      currentConvIndex=idx;
      setTopSelect(String(idx));
      updateConvMeta();
      activateSidebarItem(idx);
      openSidebar(false);
      render();
      updateLayoutHeights();
    };
    list.appendChild(item);
  });
}
function activateSidebarItem(idx){
  const list=document.getElementById('convListSide');
  [...list.children].forEach(el=>el.classList.remove('active'));
  if(list.children[idx]) list.children[idx].classList.add('active');
}
function selectConversation(idxStr){
  currentConvIndex=Number(idxStr)||0;
  updateConvMeta();
  activateSidebarItem(currentConvIndex);
  render();
  updateLayoutHeights();
}

/* 解析 mapping 树 */
function parseConversation(obj){
  const title=obj.title||obj.gist||obj.name||'';
  const created=obj.create_time||obj.update_time||obj.created||0;
  const mapping=obj.mapping; const current=obj.current_node;

  if(!mapping||!current){
    if(Array.isArray(obj.messages)){
      const msgs=obj.messages.map(normalizeLinearMessage).filter(Boolean);
      return {id:obj.id||crypto.randomUUID(),title,created,messages:msgs};
    }
    return null;
  }
  const pathIds=[]; let nodeId=current;
  while(nodeId&&mapping[nodeId]){pathIds.push(nodeId);nodeId=mapping[nodeId].parent||null;}
  pathIds.reverse();

  const messages=[]; const pathSet=new Set(pathIds);
  pathIds.forEach(pid=>{const n=mapping[pid];const m=normalizeNodeMessage(n);if(m)messages.push(m);});
  const idToIndex=new Map(); messages.forEach((m,i)=>idToIndex.set(m._nodeId,i));

  pathIds.forEach(pid=>{
    const node=mapping[pid];
    const children=Array.isArray(node.children)?node.children:[];
    const branchKids=children.filter(cid=>!pathSet.has(cid));
    if(!branchKids.length) return;
    const branchArr=[];
    branchKids.forEach(bid=>collectBranchObjects(mapping,bid,branchArr));
    const at=idToIndex.get(pid);
    if(typeof at==='number' && branchArr.length){ messages[at].previous = branchArr.slice(0,300); }
  });

  const msgs=messages.filter(m=>m.content&&m.content.trim().length);
  return {id:obj.id||crypto.randomUUID(),title,created,messages:msgs};
}
function normalizeLinearMessage(m){
  const role=m.role||(m.author?.role)||"assistant";
  const parts=Array.isArray(m.content?.parts)?m.content.parts.join("\n"):(m.content?.text||m.content||"");
  const content=typeof parts==='string'?parts:JSON.stringify(parts);
  const model=m.model||m.metadata?.model_slug||m.metadata?.model||"";
  const ts=m.create_time||m.ts||0;
  return {role,content,model,ts,previous:[]};
}
function normalizeNodeMessage(node){
  const msg=node.message; if(!msg||!msg.author)return null;
  const role=msg.author.role||"assistant";
  if(!["user","assistant","system"].includes(role))return null;
  let text="";
  if(Array.isArray(msg.content?.parts)) text=msg.content.parts.join("\n");
  else if(typeof msg.content?.text==='string') text=msg.content.text;
  else if(typeof msg.content==='string') text=msg.content;
  const model=msg.metadata?.model_slug||msg.metadata?.model||msg.model_slug||msg.model||"";
  const ts=msg.create_time||node.create_time||0;
  return {role,content:text||"",model,ts,previous:[],_nodeId:node.id};
}
function collectBranchObjects(mapping,startId,out){
  const stack=[startId];
  while(stack.length){
    const id=stack.pop(); const n=mapping[id]; if(!n)continue;
    const m=normalizeNodeMessage(n);
    if(m && m.content){ out.push({role:m.role,content:m.content,ts:m.ts,model:m.model}); }
    const kids=Array.isArray(n.children)?n.children:[];
    for(let i=kids.length-1;i>=0;i--) stack.push(kids[i]);
  }
}

/* 元信息（当前会话） */
function updateConvMeta(){
  const c=conversations[currentConvIndex];
  const meta=document.getElementById('convMeta');
  const created=c.created?new Date(c.created*1000).toLocaleString():'—';
  const total = c.messages.reduce((acc,m)=>acc+(m.content?m.content.length:0),0);
  c.totalChars = total;
  meta.textContent=`创建：${created}｜消息数：${c.messages.length}｜字数：${total}`;
  // 同步侧边栏该项的字数显示
  const list=document.getElementById('convListSide');
  if(list.children[currentConvIndex]){
    const metaMini=list.children[currentConvIndex].querySelector('.meta-mini');
    if(metaMini){
      const dateStr=c.created?new Date(c.created*1000).toLocaleDateString():'';
      metaMini.textContent = `消息 ${c.messages.length}${dateStr?` · ${dateStr}`:''} · 字数 ${total}`;
    }
  }
}

/* 渲染（含回溯默认收起 + 固定左右） */
function render(){
  try{
    const chat=document.getElementById('chat'); chat.innerHTML='';
    const c=conversations[currentConvIndex]; if(!c){chat.textContent='无会话';return;}
    const arr=c.messages.slice();
    if(!arr.length){
      const p=document.createElement('p'); p.style.opacity=.6; p.style.textAlign='center';
      p.textContent='这个会话没有可显示的消息。'; chat.appendChild(p); return;
    }

    arr.forEach(m=>{
      const name=displayName(m.role);
      if(name){
        const nm=document.createElement('div'); nm.className='name ' + (m.role==='user'?'align-right':m.role==='assistant'?'align-left':'align-center');
        nm.textContent=name; chat.appendChild(nm);
      }

      const metaTop=document.createElement('div'); metaTop.className='meta-top ' + (m.role==='user'?'align-right':m.role==='assistant'?'align-left':'align-center');
      const ts=m.ts?new Date(m.ts*1000).toLocaleString():'';
      const model=m.model||'';
      const count = (m.content||'').length;
      metaTop.innerHTML = `<span>${ts||''}</span>${model?`<span class="model-chip">${escapeHTML(model)}</span>`:''}<span>字数：${count}</span>`;
      chat.appendChild(metaTop);

      const div=document.createElement('div'); div.className=`msg ${clsByRole(m.role)}`; div.innerText=m.content||''; chat.appendChild(div);

      if(Array.isArray(m.previous) && m.previous.length){
        const details=document.createElement('details'); details.className='branch'; // 默认收起
        const sum=document.createElement('summary');
        sum.innerHTML=`<span class="branch-badge">分支</span><span>回溯共 ${m.previous.length} 条（点此展开）</span>`;
        details.appendChild(sum);

        const thread=document.createElement('div'); thread.className='branch-thread';
        m.previous.forEach(b=>{
          const nm2=displayName(b.role);
          if(nm2){
            const nm=document.createElement('div'); nm.className='name ' + (b.role==='user'?'align-right':b.role==='assistant'?'align-left':'align-center');
            nm.textContent=nm2; thread.appendChild(nm);
          }
          const top=document.createElement('div'); top.className='meta-top ' + (b.role==='user'?'align-right':'align-left');
          const ts2=b.ts?new Date(b.ts*1000).toLocaleString():'';
          const model2=b.model||'';
          const count2=(b.content||'').length;
          top.innerHTML = `<span>${ts2||''}</span>${model2?`<span class="model-chip">${escapeHTML(model2)}</span>`:''}<span>字数：${count2}</span>`;
          thread.appendChild(top);

          const bdiv=document.createElement('div'); bdiv.className=`msg ${clsByRole(b.role)}`; bdiv.innerText=b.content||''; thread.appendChild(bdiv);
        });
        details.appendChild(thread);
        chat.appendChild(details);
      }
    });

    updateConvMeta();
    updateLayoutHeights();
  }catch(e){showErr('渲染失败：'+e.message)}
}
function clsByRole(role){if(role==='user')return 'user';if(role==='system')return 'system';return 'assistant';}

/* 导出：当前 & 批量使用 */
function exportCurrentConversation(){
  exportConversationByIndex(currentConvIndex);
}
function exportConversationByIndex(idx){
  try{
    const c=conversations[idx]; if(!c) { showErr('没有可导出的会话'); return; }
    const rootStyle = getComputedStyle(document.documentElement);
    const vars = ['--user','--assistant','--sys','--bubble-max','--bg-light','--text-light','--chip'];
    const cssVars = vars.map(v=>`${v}:${rootStyle.getPropertyValue(v).trim()}`).join(';');
    const esc = s => (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const bubble = (role, ts, model, text) => {
      const side = role==='user'?'align-right':role==='assistant'?'align-left':'align-center';
      const meta = `<div class="meta-top ${side}"><span>${ts||''}</span>${model?`<span class="model-chip">${esc(model)}</span>`:''}<span>字数：${(text||'').length}</span></div>`;
      return `${meta}<div class="msg ${role}">${esc(text||'')}</div>`;
    };
    let body = '';
    c.messages.forEach(m=>{
      const ts = m.ts?new Date(m.ts*1000).toLocaleString():'';
      const nm = (function(role){
        const n=prefs.names||{}; if(role==='user')return n.user||''; if(role==='assistant')return n.assistant||''; if(role==='system')return n.system||''; return '';
      })(m.role);
      if(nm){ body += `<div class="name ${m.role==='user'?'align-right':m.role==='assistant'?'align-left':'align-center'}">${esc(nm)}</div>`; }
      body += bubble(m.role, ts, m.model||'', m.content||'');
      if(Array.isArray(m.previous)&&m.previous.length){
        body += `<details class="branch"><summary><span class="branch-badge">分支</span><span>回溯共 ${m.previous.length} 条（点此展开）</span></summary><div class="branch-thread">`;
        m.previous.forEach(b=>{
          const ts2 = b.ts?new Date(b.ts*1000).toLocaleString():'';
          const nm2 = (function(role){
            const n=prefs.names||{}; if(role==='user')return n.user||''; if(role==='assistant')return n.assistant||''; if(role==='system')return n.system||''; return '';
          })(b.role);
          if(nm2){ body += `<div class="name ${b.role==='user'?'align-right':'align-left'}">${esc(nm2)}</div>`; }
          body += bubble(b.role, ts2, b.model||'', b.content||'');
        });
        body += `</div></details>`;
      }
    });
    const html = `<!DOCTYPE html><html lang="zh"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>${esc(c.title||'导出')}</title>
<style>
:root{${cssVars}}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;background:var(--bg-light);color:var(--text-light)}
.container{padding:1rem;max-width:980px;margin:0 auto;display:flex;flex-direction:column;gap:.8rem}
.chat{display:flex;flex-direction:column;gap:.8rem}
.msg{max-width:var(--bubble-max);padding:.65rem .85rem;border-radius:14px;white-space:pre-wrap;line-height:1.55}
.msg.user{background:var(--user);color:#fff;margin-left:auto}
.msg.assistant{background:var(--assistant);color:#fff;margin-right:auto}
.msg.system{background:var(--sys);color:#fff;margin-left:auto;margin-right:auto}
.name{font-size:.78rem;opacity:.8;margin:0 .2rem .2rem .2rem}
.meta-top{font-size:.78rem;opacity:.85;margin:.1rem .2rem;display:flex;gap:.5rem;flex-wrap:wrap}
.align-right{margin-left:auto;text-align:right}
.align-left{margin-right:auto;text-align:left}
.align-center{margin-left:auto;margin-right:auto;text-align:center}
.model-chip{padding:.1rem .45rem;border-radius:999px;background:var(--chip)}
.branch{margin:.5rem 0 .2rem 0;border-radius:12px;padding:.3rem .6rem;border-left:4px solid var(--assistant);
  box-shadow:inset 0 0 0 1px rgba(0,0,0,.06);background:#fff6}
.branch-thread{display:flex;flex-direction:column;gap:.55rem;margin:.4rem .1rem .55rem .25rem}
.branch summary{cursor:pointer;list-style:none;display:flex;gap:.5rem;align-items:center}
.branch summary::-webkit-details-marker{display:none}
.branch .branch-badge{font-size:.72rem;padding:.1rem .45rem;border-radius:999px;background:var(--chip)}
</style></head><body>
<div class="container">
  <h2 style="margin:.2rem 0 1rem 0">${esc(c.title||'(无标题)')}</h2>
  <div class="chat">${body}</div>
</div></body></html>`;
    const blob=new Blob([html],{type:'text/html'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=`${(c.title||'chat_export').replace(/[\\/:*?"<>|]/g,'_')}.html`; 
    // 用 setTimeout 保证 iOS 正常触发下载
    setTimeout(()=>{ a.click(); URL.revokeObjectURL(url); }, 0);
  }catch(e){showErr('导出失败：'+e.message)}
}

/* 工具 */
function escapeHTML(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}

/* 尺寸变化时更新布局 */
window.addEventListener('resize', updateLayoutHeights);
window.addEventListener('orientationchange', ()=>{setTimeout(updateLayoutHeights, 300);});
</script>
</body>
</html>
